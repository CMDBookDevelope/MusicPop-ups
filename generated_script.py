
import sounddevice as sd
import librosa
import tkinter as tk
import time
import json
import os
import random

class AudioPlayer:
    def __init__(self):
        self.root = tk.Tk()
        self.root.withdraw()
        self.windows = []

    def show_error_popup(self):
        top = tk.Toplevel(self.root)
        top.title("Warning")
        msg = tk.Label(top, text="小心台阶", font=('Helvetica', 16))
        msg.pack(padx=50, pady=50)  # Increase padding for better visibility
        self.windows.append(top)
        
        # Set random position within the screen
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        window_width = 300
        window_height = 200
        x = random.randint(0, screen_width - window_width)
        y = random.randint(0, screen_height - window_height)
        top.geometry(f"{window_width}x{window_height}+{x}+{y}")
        
        self.root.update()  # Ensure the window is shown and updated

    def close_all_popups(self):
        for win in self.windows:
            win.destroy()
        self.windows.clear()

    def play_audio_with_popups(self, audio_path, onsets):
        print("Loading audio file from:", audio_path)
        try:
            y, sr = librosa.load(audio_path)
        except Exception as e:
            print("Error loading audio file:", e)
            return

        start_time = time.time()
        print("Playing audio...")
        sd.play(y, sr)
        
        onset_index = 0
        while onset_index < len(onsets):
            current_time = time.time() - start_time
            if current_time >= onsets[onset_index]:
                self.show_error_popup()
                onset_index += 1
            time.sleep(0.01)
        
        sd.wait()
        print("Audio playback finished.")
        self.close_all_popups()

def play_audio_with_popups():
    audio_path = os.path.join(os.path.dirname(__file__), "audio.mp3")
    onsets = json.loads('[0.06965986394557823, 3.645532879818594, 4.1099319727891155, 4.551111111111111, 6.501587301587302, 6.942766439909297, 8.475283446712018, 8.916462585034013, 9.357641723356009, 10.866938775510205, 11.3081179138322, 11.749297052154194, 13.25859410430839, 13.722993197278912, 14.02485260770975, 14.164172335600908, 14.466031746031746, 15.069750566893424, 15.975328798185942, 16.114648526077097, 16.416507936507937, 18.06512471655329, 18.36698412698413, 18.970702947845805, 19.272562358276645, 21.36235827664399, 23.475374149659864, 23.777233560090703, 24.079092970521543, 25.054331065759637, 25.658049886621317, 25.86702947845805, 25.959909297052153, 26.16888888888889, 26.563628117913833, 27.77106575963719, 28.35156462585034, 28.514104308390024, 30.00018140589569, 30.162721088435376, 30.30204081632653, 30.441360544217687, 30.603900226757368, 30.67356009070295, 30.743219954648527, 30.975419501133786, 32.55437641723356, 32.8562358276644, 33.13487528344671, 34.50485260770975, 34.644172335600906, 34.87637188208617, 34.94603174603174, 35.178231292517005, 35.247891156462586, 35.54975056689342, 36.75718820861678, 37.05904761904762, 37.36090702947846, 38.568344671201814, 39.14884353741497, 39.65968253968254, 40.35628117913832, 40.936780045351476, 42.74793650793651, 43.35165532879819, 43.95537414965986, 44.39655328798186, 44.535873015873015, 44.83773242630385, 45.139591836734695, 45.302131519274376, 45.37179138321996, 45.743310657596375, 47.55446712018141, 48.134965986394555, 48.66902494331066, 49.24952380952381, 52.848616780045354, 53.47555555555556, 53.91673469387755, 54.05605442176871, 54.52045351473923, 54.659773242630386, 55.147392290249435, 55.263492063492066, 55.5653514739229, 55.635011337868484, 55.72789115646258, 55.86721088435374, 56.23873015873016, 56.33160997732426, 56.401269841269844, 56.47092970521542, 56.77278911564626, 56.91210884353742, 57.00498866213152, 57.0746485260771, 57.446167800453516, 57.51582766439909, 57.84090702947846, 58.049886621315196, 58.11954648526077, 58.258866213151926, 58.700045351473925, 58.862585034013605, 59.025124716553286, 59.32698412698413, 59.466303854875285, 59.9307029478458, 60.070022675736965, 60.232562358276645, 60.3718820861678, 60.441541950113375, 60.51120181405896, 60.65052154195011, 61.045260770975055, 61.11492063492064, 61.18458049886621, 61.27746031746032, 61.44, 61.57931972789115, 61.718639455782316, 61.78829931972789, 61.85795918367347, 62.15981859410431, 62.299138321995464, 62.461678004535145, 62.76353741496599, 63.065396825396824, 63.36725623582767, 63.669115646258504, 63.97097505668934, 64.27283446712018, 64.57469387755103, 64.87655328798186, 65.15519274376418, 65.45705215419501, 65.75891156462585, 66.06077097505668, 66.36263038548753, 66.66448979591837, 66.96634920634921, 67.10566893424036, 67.26820861678004, 67.4075283446712, 67.54684807256236, 67.70938775510204, 67.84870748299319, 68.01124716553288, 68.15056689342404, 68.31310657596372, 68.45242630385488, 68.61496598639455, 68.75428571428571, 68.89360544217688, 69.05614512471655, 69.21868480725624, 69.35800453514739, 69.49732426303855, 69.65986394557824, 69.75274376417234, 69.82240362811791, 69.89206349206349, 69.96172335600907, 70.05460317460317, 70.12426303854875, 70.19392290249434, 70.26358276643991, 70.35646258503401, 70.4261224489796, 70.49578231292517, 70.56544217687075, 70.63510204081632, 70.72798185941043, 70.79764172335601, 70.86730158730158, 70.93696145124717, 71.02984126984127, 71.09950113378684, 71.16916099773243, 71.23882086167801, 71.40136054421768, 71.47102040816327, 72.05151927437642, 73.25895691609978, 74.46639455782314, 75.39519274376417, 75.67383219954648, 76.85804988662132, 78.06548752834468, 78.66920634920635, 79.27292517006802, 79.87664399092971, 80.20172335600907, 80.34104308390023, 80.45714285714286, 81.06086167800453, 81.3859410430839, 81.66458049886621, 82.26829931972789, 82.87201814058957, 84.82249433106576, 84.96181405895692, 85.26367346938775, 85.86739229024943, 86.47111111111111, 87.07482993197279, 87.65532879818593, 88.8627664399093, 89.46648526077098, 89.79156462585034, 89.93088435374149, 90.07020408163265, 90.67392290249433, 90.9990022675737, 91.25442176870749, 92.46185941043083, 93.06557823129252, 93.66929705215419, 94.27301587301588, 94.87673469387755, 96.06095238095239, 96.20027210884354, 96.66467120181406, 97.15229024943311, 97.26839002267573, 97.87210884353742, 98.47582766439909, 99.54394557823129, 99.66004535147393, 100.2637641723356, 100.58884353741496, 100.86748299319729, 101.47120181405896, 102.07492063492063, 103.42167800453515, 103.86285714285714, 104.18793650793651, 104.46657596371882, 104.76843537414966, 105.0702947845805, 105.67401360544218, 106.858231292517, 107.16009070294784, 108.06566893424036, 108.66938775510204, 109.15700680272109, 109.27310657596372, 109.57496598639456, 109.8768253968254, 110.15546485260771, 110.45732426303854, 110.7591836734694, 111.06104308390023, 111.36290249433107, 111.96662131519274, 112.26848072562358, 112.57034013605443, 112.7328798185941, 112.84897959183674, 113.15083900226757, 113.45269841269841, 113.75455782312925, 113.91709750566893, 114.0564172335601, 114.19573696145125, 114.35827664399093, 114.66013605442177, 114.9619954648526, 115.1245351473923, 115.26385487528344, 115.54249433106575, 115.70503401360544, 115.8443537414966, 116.16943310657597, 116.30875283446711, 116.44807256235828, 116.74993197278911, 117.05179138321995, 117.3536507936508, 117.51619047619047, 117.65551020408164, 117.95736961451247, 118.11990929705216, 118.25922902494331, 118.56108843537415, 118.72362811791383, 118.86294784580498, 119.09514739229024, 119.16480725623583, 119.2344671201814, 119.3273469387755, 119.44344671201814, 119.7685260770975, 119.93106575963719, 120.04716553287982, 120.37224489795918, 120.67410430839003, 120.95274376417234, 121.55646258503401, 121.67256235827665, 121.85832199546485, 122.16018140589568, 122.29950113378685, 122.46204081632654, 122.76390022675737, 123.06575963718821, 123.36761904761904, 123.66947845804988, 123.80879818594104, 123.90167800453514, 123.97133786848073, 124.27319727891157, 124.55183673469388, 124.85369614512472, 125.15555555555555, 125.29487528344671, 125.45741496598639, 125.75927437641724, 126.36299319727891, 126.66485260770975, 126.96671201814058, 127.10603174603175, 127.26857142857143, 127.8722902494331, 128.17414965986396, 128.4760090702948, 128.61532879818594, 128.68498866213153, 128.77786848072563, 129.05650793650793, 129.35836734693876, 129.66022675736963, 130.2639455782313, 130.56580498866214, 131.47138321995465, 131.6107029478458, 132.678820861678, 132.81814058956917, 132.95746031746032, 133.86303854875283, 134.0255782312925, 134.4667573696145, 135.0704761904762, 135.2330158730159, 135.81351473922902, 136.64943310657597, 137.46213151927438, 137.62467120181407, 137.76399092970522, 138.66956916099772, 138.8321088435374, 139.2732879818594, 139.8770068027211, 140.1556462585034, 140.62004535147392, 141.0612244897959, 141.2237641723356, 141.43274376417233, 141.6649433106576, 141.82748299319726, 142.26866213151928, 142.43120181405897, 142.57052154195011, 143.47609977324262, 143.6154195011338, 144.05659863945579, 144.14947845804988, 144.66031746031746, 144.82285714285715, 144.9621768707483, 145.42657596371882, 145.8677551020408, 146.23927437641723, 147.07519274376418, 147.21451247165533, 147.377052154195, 148.259410430839]')
    
    player = AudioPlayer()
    player.play_audio_with_popups(audio_path, onsets)

play_audio_with_popups()
